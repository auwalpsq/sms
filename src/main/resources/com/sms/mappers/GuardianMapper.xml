<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sms.mappers.GuardianMapper">

    <!-- ✅ Result Map -->
    <resultMap id="guardianResultMap" type="com.sms.entities.Guardian">
        <id property="id" column="id" javaType="long"/>
        <result property="firstName" column="first_name"/>
        <result property="middleName" column="middle_name"/>
        <result property="lastName" column="last_name"/>
        <result property="gender" column="gender" javaType="com.sms.entities.Gender"/>
        <result property="dateOfBirth" column="date_of_birth" javaType="java.time.LocalDate"/>
        <result property="createdAt" column="created_at" javaType="java.time.LocalDateTime"/>
        <result property="updatedAt" column="updated_at" javaType="java.time.LocalDateTime"/>
        <result property="email" column="email"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="address" column="address"/>
        <result property="city" column="city"/>
        <result property="state" column="state"/>
        <result property="guardianId" column="guardian_id"/>
        <result property="occupation" column="occupation"/>
        <result property="employer" column="employer"/>
        <result property="alternatePhone" column="alternate_phone"/>
    </resultMap>

    <!-- ✅ Inserts -->
    <insert id="insertIntoPersons" useGeneratedKeys="true" keyProperty="id" keyColumn="id" parameterType="com.sms.entities.Guardian">
        INSERT INTO persons (first_name, middle_name, last_name, gender, date_of_birth, person_type, created_at, updated_at)
        VALUES (#{firstName}, #{middleName}, #{lastName}, #{gender}, #{dateOfBirth}, 'GUARDIAN', #{createdAt}, #{updatedAt})
        RETURNING id
    </insert>

    <insert id="insertIntoContactDetails">
        INSERT INTO contact_details (id, email, phone_number, address, city, state)
        VALUES (#{id}, #{email}, #{phoneNumber}, #{address}, #{city}, #{state})
    </insert>

    <insert id="insertIntoGuardians">
        INSERT INTO guardians (id, guardian_id, occupation, employer, alternate_phone)
        VALUES (#{id}, #{guardianId}, #{occupation}, #{employer}, #{alternatePhone})
    </insert>

    <!-- ✅ Update -->
    <update id="update">
        UPDATE persons
        SET first_name = #{firstName},
        middle_name = #{middleName},
        last_name = #{lastName},
        gender = #{gender},
        date_of_birth = #{dateOfBirth},
        updated_at = #{updatedAt}
        WHERE id = #{id};

        UPDATE contact_details
        SET email = #{email},
        phone_number = #{phoneNumber},
        address = #{address},
        city = #{city},
        state = #{state}
        WHERE id = #{id};

        UPDATE guardians
        SET guardian_id = #{guardianId},
        occupation = #{occupation},
        employer = #{employer},
        alternate_phone = #{alternatePhone}
        WHERE id = #{id};
    </update>

    <!-- ✅ Delete -->
    <delete id="delete" parameterType="long">
        DELETE FROM guardians WHERE id = #{id};
        DELETE FROM contact_details WHERE id = #{id};
        DELETE FROM persons WHERE id = #{id};
    </delete>

    <select id="findById" parameterType="long" resultMap="guardianResultMap">
        SELECT
        g.*,
        p.first_name,
        p.middle_name,
        p.last_name,
        p.gender,
        p.date_of_birth,
        p.created_at,
        p.updated_at
        FROM guardians g
        JOIN persons p ON g.id = p.id
        WHERE g.id = #{id}
    </select>

    <!-- ✅ Unified paginated + search query -->
    <select id="findPage" resultMap="guardianResultMap">
        SELECT
        p.id,
        p.first_name,
        p.middle_name,
        p.last_name,
        p.gender,
        p.date_of_birth,
        p.created_at,
        p.updated_at,
        c.email,
        c.phone_number,
        c.address,
        c.city,
        c.state,
        g.guardian_id,
        g.occupation,
        g.employer,
        g.alternate_phone
        FROM persons p
        JOIN contact_details c ON p.id = c.id
        JOIN guardians g ON c.id = g.id
        <where>
            <if test="query != null and query.trim() != ''">
                (
                LOWER(p.first_name) LIKE LOWER(CONCAT('%', #{query}, '%'))
                OR LOWER(p.last_name) LIKE LOWER(CONCAT('%', #{query}, '%'))
                OR LOWER(c.email) LIKE LOWER(CONCAT('%', #{query}, '%'))
                OR LOWER(c.phone_number) LIKE LOWER(CONCAT('%', #{query}, '%'))
                )
            </if>
        </where>
        ORDER BY p.created_at DESC, p.id DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- ✅ Count for pagination (supports search) -->
    <select id="countFiltered" resultType="int">
        SELECT COUNT(*)
        FROM persons p
        JOIN contact_details c ON p.id = c.id
        JOIN guardians g ON c.id = g.id
        <where>
            <if test="query != null and query.trim() != ''">
                (
                LOWER(p.first_name) LIKE LOWER(CONCAT('%', #{query}, '%'))
                OR LOWER(p.last_name) LIKE LOWER(CONCAT('%', #{query}, '%'))
                OR LOWER(c.email) LIKE LOWER(CONCAT('%', #{query}, '%'))
                OR LOWER(c.phone_number) LIKE LOWER(CONCAT('%', #{query}, '%'))
                )
            </if>
        </where>
    </select>

</mapper>