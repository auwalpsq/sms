<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sms.mappers.StudentMapper">

    <resultMap id="StudentResultMap" type="com.sms.entities.Student">
        <id property="id" column="id"/>
        <result property="admissionNumber" column="admission_number"/>
        <result property="admittedOn" column="admitted_on"/>
        <result property="admissionAccepted" column="admission_accepted"/>
        <result property="admissionAcceptedOn" column="admission_accepted_on"/>

        <!-- Associations (must all come after result definitions) -->
        <association property="applicant" column="applicant_id"
                     javaType="com.sms.entities.Applicant"
                     select="com.sms.mappers.ApplicantMapper.findById"/>
        <association property="admittedSession" column="admitted_session_id"
                     javaType="com.sms.entities.AcademicSession"
                     select="com.sms.mappers.AcademicSessionMapper.findById"/>
        <association property="admittedClass" column="admitted_class_id"
                     javaType="com.sms.entities.SchoolClass"
                     select="com.sms.mappers.SchoolClassMapper.findById"/>
    </resultMap>

    <insert id="save" parameterType="com.sms.entities.Student"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO students (
        admission_number, applicant_id,
        admitted_session_id, admitted_class_id, admitted_on, admission_accepted
        ) VALUES (
        #{admissionNumber}, #{applicant.id},
        #{admittedSession.id}, #{admittedClass.id}, #{admittedOn}, #{admissionAccepted}
        )
    </insert>

    <select id="findById" resultMap="StudentResultMap">
        SELECT * FROM students WHERE id = #{id}
    </select>

    <select id="findByAdmissionNumber" resultMap="StudentResultMap">
        SELECT * FROM students WHERE admission_number = #{admissionNumber}
    </select>

    <select id="findAll" resultMap="StudentResultMap">
        SELECT * FROM students
    </select>

    <select id="findBySession" resultMap="StudentResultMap">
        SELECT * FROM students WHERE admitted_session_id = #{sessionId}
    </select>

    <select id="findByClass" resultMap="StudentResultMap">
        SELECT * FROM students WHERE admitted_class_id = #{classId}
    </select>

    <delete id="deleteById">
        DELETE FROM students WHERE id = #{id}
    </delete>

    <select id="countAll" resultType="long">
        SELECT COUNT(*) FROM students
    </select>

    <select id="findByApplicantId" resultMap="StudentResultMap">
        SELECT * FROM students WHERE applicant_id = #{applicantId}
    </select>

    <update id="markAccepted" parameterType="long">
        UPDATE students
        SET admission_accepted = TRUE,
        admission_accepted_on = NOW()
        WHERE id = #{id}
    </update>

</mapper>