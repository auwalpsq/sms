<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sms.mappers.ContactPersonMapper">

    <resultMap id="ContactPersonResultMap" type="com.sms.entities.ContactPerson">
        <result column="phone_number" property="phoneNumber"/>
        <result column="email" property="email"/>
        <result column="address" property="address"/>
        <result column="city" property="city"/>
        <result column="state" property="state"/>
    </resultMap>

    <insert id="save" parameterType="com.sms.entities.ContactPerson">
        INSERT INTO contact_details (id, phone_number, email, address, city, state)
        VALUES (#{id}, #{phoneNumber}, #{email}, #{address}, #{city}, #{state})
    </insert>

    <update id="update" parameterType="com.sms.entities.ContactPerson">
        UPDATE contact_details
        SET phone_number = #{phoneNumber},
        email = #{email},
        address = #{address},
        city = #{city},
        state = #{state}
        WHERE id = #{id}
    </update>

    <select id="findById" parameterType="long" resultMap="ContactPersonResultMap">
        SELECT p.*, c.phone_number, c.email, c.address, c.city, c.state
        FROM persons p
        JOIN contact_details c ON p.id = c.id
        WHERE p.id = #{id}
    </select>

    <delete id="delete" parameterType="long">
        DELETE FROM contact_details WHERE id = #{id}
    </delete>

    <select id="findByEmail" parameterType="string" resultMap="ContactPersonResultMap">
        SELECT p.*, c.*
        FROM persons p
        JOIN contact_details c ON p.id = c.id
        WHERE LOWER(c.email) = LOWER(#{email})
        LIMIT 1
    </select>

    <select id="emailExists" parameterType="string" resultType="boolean">
        SELECT EXISTS(
        SELECT 1 FROM contact_details WHERE LOWER(email) = LOWER(#{email})
        )
    </select>

    <select id="phoneExists" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM contact_details
        WHERE phone_number = #{phone}
    </select>

</mapper>